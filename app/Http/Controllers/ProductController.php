<?php

namespace App\Http\Controllers;

use Validator;
use App\Product;
use App\ProductCategory;
use App\ProductImage;
use Session;
use Redirect;
use Auth;
use Input;
use Helper;
use Image;
use File;
use Response;
use DB;
use Illuminate\Http\Request;

class ProductController extends Controller {

    private $fileSize = '102400';
    private $productCategoryArr = [];

    public function findParentCategory($parentId = null, $id = null) {
        $dataArr = ProductCategory::find($parentId);
        $this->productCategoryArr[$id] = isset($this->productCategoryArr[$id]) ? $this->productCategoryArr[$id] : '';
        if (!empty($dataArr['name'])) {
            $this->productCategoryArr[$id] = $dataArr['name'] . ' &raquo; ' . $this->productCategoryArr[$id];
        }

        if (!empty($dataArr['parent_id'])) {
            $this->findParentCategory($dataArr['parent_id'], $id);
        }

        //exclude last &raquo; sign
        $this->productCategoryArr[$id] = trim($this->productCategoryArr[$id], ' &raquo; ');
        return true;
    }

    public function index(Request $request) {
        $productCategory = Helper::getAllProductCategory();
        //passing param for custom function
        $qpArr = $request->all();
        $nameArr = Product::select('name')->orderBy('name', 'asc')->get();
        $productCategoryArr = Helper::getAllProductCategory();

        $targetArr = Product::join('product_category', 'product_category.id', '=', 'product.product_category_id')
                ->select('product.*', 'product_category.name as product_category');



        //begin filtering
        $searchText = $request->search;
        if (!empty($searchText)) {
            $targetArr->where(function ($query) use ($searchText) {

                $query->where('product.name', 'LIKE', '%' . $searchText . '%');
            });
        }

        if (!empty($request->product_category)) {
            $targetArr = $targetArr->where('product.product_category_id', $request->product_category);
        }

        if (!empty($request->product_info)) {
            $targetArr = $targetArr->where('product.product_info', $request->product_info);
        }

        //end filtering

        $productIdArr = $targetArr->pluck('product.id', 'product.id')->toArray();

        $targetArr = $targetArr->orderBy('product.id', 'desc')->paginate(Session::get('paginatorCount'));

        //change page number after delete if no data has current page
        if ($targetArr->isEmpty() && isset($qpArr['page']) && ($qpArr['page'] > 1)) {
            $page = ($qpArr['page'] - 1);
            return redirect('/product?page=' . $page);
        }

        return view('website.product.index')->with(compact('qpArr', 'targetArr', 'nameArr', 'productCategoryArr'));
    }

    public function create(Request $request) {
        //passing param for custom function
        $qpArr = $request->all();
        $productCategoryArr = Helper::getAllProductCategory();


        return view('website.product.create')->with(compact('qpArr', 'productCategoryArr'));
    }

    //store
    public function store(Request $request) {
        //passing param for custom function
        $qpArr = $request->all();
        $pageNumber = $qpArr['filter'];
//        echo '<pre>';
//        print_r($request->toArray());
//        exit;
        $message = [];
        $rules = [
            'name' => 'required',
            'product_info' => 'required',
            'product_category_id' => 'required|not_in:0',
            'price' => 'required',
            'description' => 'required',
        ];
        if (!empty($request->check_special_price)) {
            $rules['special_price'] = 'required';
        }
        $validator = Validator::make($request->all(), $rules, $message);

        if ($validator->fails()) {
            return Response::json(array('success' => false, 'heading' => 'Validation Error', 'message' => $validator->errors()), 400);
        }

        $target = new Product;
        $target->name = $request->name;
        $target->product_category_id = $request->product_category_id;
        $target->product_info = $request->product_info;
        $target->price = $request->price;
        $target->check_special_price = $request->check_special_price;
        $target->special_price = $request->special_price ?? null;
        $target->description = $request->description;
        $target->status = $request->status;

        DB::beginTransaction();
        try {
            $target->save();
            DB::commit();
            return Response::json(array('heading' => 'Success', 'message' => __('english.PRODUCT_CREATED_SUCCESSFULLY')), 200);
        } catch (\Throwable $e) {
            DB::rollback();
            echo $e->getMessage();
            exit;
            return Response::json(array('success' => false, 'message' => __('english.PRODUCT_COULD_NOT_BE_CREATED')), 401);
        }
    }

    public function edit(Request $request, $id) {
        $target = Product::find($id);
//                        echo '<pre>';
//        print_r($target->toArray());
//        exit;
        if (empty($target)) {
            Session::flash('error', trans('english.INVALID_DATA_ID'));
            return redirect('product');
        }

        //passing param for custom function
        $qpArr = $request->all();

        $productCategoryArr = Helper::getAllProductCategory();

        return view('website.product.edit')->with(compact('qpArr', 'target', 'productCategoryArr'));
    }

    //update
    public function update(Request $request) {


        $id = $request->id;
        $target = Product::find($id);
        //begin back same page after update
        $qpArr = $request->all();
        $pageNumber = $qpArr['filter'];



        $message = [];
        $rules = [
            'name' => 'required',
            'product_info' => 'required',
            'product_category_id' => 'required|not_in:0',
            'price' => 'required',
            'description' => 'required',
        ];
        if (!empty($request->check_special_price)) {
            $rules['special_price'] = 'required';
        }
        //Validation Rules for FSC Certification


        $validator = Validator::make($request->all(), $rules, $message);

        if ($validator->fails()) {
            return Response::json(array('success' => false, 'heading' => 'Validation Error', 'message' => $validator->errors()), 400);
        }

        $target->name = $request->name;
        $target->product_info = $request->product_info;
        $target->product_category_id = $request->product_category_id;
        $target->price = $request->price;
        $target->check_special_price = $request->check_special_price;
        $target->special_price = $request->special_price ?? null;
        $target->description = $request->description;
        $target->status = $request->status;

        if ($target->save()) {
            return Response::json(array('heading' => 'Success', 'message' => __('english.PRODUCT_UPDATED_SUCCESSFULLY')), 200);
        } else {
            return Response::json(array('success' => false, 'message' => __('english.PRODUCT_COULD_NOT_BE_UPDATED')), 401);
        }
    }

    public function destroy(Request $request, $id) {
        $target = Product::find($id);
        //begin back same page after update
        $qpArr = $request->all();
        $pageNumber = !empty($qpArr['page']) ? '?page=' . $qpArr['page'] : '?page=';
        //end back same page after update
        if (empty($target)) {
            Session::flash('error', __('english.INVALID_DATA_ID'));
        }

        if ($target->delete()) {
            Session::flash('error', __('english.PRODUCT_DELETED_SUCCESSFULLY'));
        } else {
            Session::flash('error', __('english.PRODUCT_COULD_NOT_BE_DELETED'));
        }
        return redirect('product' . $pageNumber);
    }

    public function filter(Request $request) {
        $url = 'search=' . urlencode($request->search) . '&product_category=' . $request->product_category
                . '&product_code=' . $request->product_code . '&product_unit=' . $request->product_unit;
        return Redirect::to('admin/product?' . $url);
    }

    public function getProductImage(Request $request, $id) {
        $target = Product::leftJoin('product_image', 'product_image.product_id', 'product.id')->where('product.id', $id)->select('product.*', 'product_image.image')->first();

        if (empty($target)) {
            Session::flash('error', trans('english.INVALID_DATA_ID'));
            return redirect('product');
        }
        $qpArr = $request->all();
        $imageArr = [];
        if (!empty($target->image)) {
            $imageArr = json_decode($target->image, true);
        }

        return view('website.product.productImage')->with(compact('qpArr', 'target', 'imageArr'));
    }

    public function newProductImage() {

        $view = view('website.product.newProductImage')->render();
        return response()->json(['html' => $view]);
    }

    public function setProductImage(Request $request) {
//        echo '<pre>';
//        print_r($request->toArray());
//        exit;
        $qpArr = $request->all();
        $pageNumber = $qpArr['filter'];
        $data = [];
        $i = 0;

        if ($request->hasFile('product_image')) {
            $imageArr = $request->file('product_image');
            foreach ($imageArr as $key => $image) {
                $img = uniqid() . '_' . $i . '.' . $image->getClientOriginalExtension();
                $destinationPath = public_path('uploads/website/product/');
                $image->move($destinationPath, $img);
                $data[$i] = $img;
                $i++;
            }
        }
        
        $prevImageArr = $request->prev_product_image;
        if (!empty($prevImageArr)) {
            foreach ($prevImageArr as $key1 => $prevImage) {
                $data[$i] = $prevImage;
                $i++;
            }
        }
        
        
        $productImageInfo = ProductImage::where('product_id', $request->product_id)->first();
        if (!empty($productImageInfo)) {
            $productImaNameArr = json_decode($productImageInfo->image, true);
        }
        ProductImage::where('product_id', $request->product_id)->delete();
        $target = new ProductImage;
        $target->product_id = $request->product_id;
        $target->image = json_encode($data);
        $target->created_by = Auth::user()->id;
        $target->created_at = date('Y-m-d H:i:s');

        if ($target->save()) {
            Session::flash('success', __('english.PRODUCT_IMAGE_SAVED_SUCCESSFULLY'));
            return redirect('product' . $pageNumber);
        } else {
            Session::flash('error', __('english.PRODUCT_CATEGORY_COULD_NOT_BE_UPDATED'));
            return redirect('product/' . $request->product_id . '/getProductImage' . $pageNumber);
        }
    }

    //***************************************  Thumbnails Generating Functions :: Start *****************************
    public function load($filename) {
        $image_info = getimagesize($filename);
        $this->image_type = $image_info[2];
        if ($this->image_type == IMAGETYPE_JPEG) {
            $this->image = imagecreatefromjpeg($filename);
        } elseif ($this->image_type == IMAGETYPE_GIF) {
            $this->image = imagecreatefromgif($filename);
        } elseif ($this->image_type == IMAGETYPE_PNG) {
            $this->image = imagecreatefrompng($filename);
        }
    }

    public function save($filename, $image_type = IMAGETYPE_JPEG, $compression = 75, $permissions = null) {
        if ($image_type == IMAGETYPE_JPEG) {
            imagejpeg($this->image, $filename, $compression);
        } elseif ($image_type == IMAGETYPE_GIF) {
            imagegif($this->image, $filename);
        } elseif ($image_type == IMAGETYPE_PNG) {
            imagepng($this->image, $filename);
        }
        if ($permissions != null) {
            chmod($filename, $permissions);
        }
    }

    public function output($image_type = IMAGETYPE_JPEG) {
        if ($image_type == IMAGETYPE_JPEG) {
            imagejpeg($this->image);
        } elseif ($image_type == IMAGETYPE_GIF) {
            imagegif($this->image);
        } elseif ($image_type == IMAGETYPE_PNG) {
            imagepng($this->image);
        }
    }

    public function getWidth() {
        return imagesx($this->image);
    }

    public function getHeight() {
        return imagesy($this->image);
    }

    public function resizeToHeight($height) {
        $ratio = $height / $this->getHeight();
        $width = $this->getWidth() * $ratio;
        $this->resize($width, $height);
    }

    public function scale($scale) {
        $width = $this->getWidth() * $scale / 100;
        $height = $this->getheight() * $scale / 100;
        $this->resize($width, $height);
    }

    public function resize($width, $height) {
        $new_image = imagecreatetruecolor($width, $height);
        imagecopyresampled($new_image, $this->image, 0, 0, 0, 0, $width, $height, $this->getWidth(), $this->getHeight());
        $this->image = $new_image;
    }

}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
